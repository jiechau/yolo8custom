<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YOLOv8 Inference</title>
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
    <style>
        #canvas {
            border: 1px solid black;
        }
    </style>
</head>
<body>
    <h1>YOLOv8 Inference</h1>
    <input type="text" id="image-url" value="https://raw.githubusercontent.com/ultralytics/yolov5/master/data/images/bus.jpg" style="width: 80%;">
    <button onclick="runInference()">Submit</button>
    <canvas id="canvas" width="640" height="640"></canvas>
    
    <script>
        const classNames = ['person', 'bicycle', 'car', 'motorcycle', 'airplane', 'bus', 'train', 'truck', 'boat', 'traffic light', 'fire hydrant', 'stop sign', 'parking meter', 'bench', 'bird', 'cat', 'dog', 'horse', 'sheep', 'cow', 'elephant', 'bear', 'zebra', 'giraffe', 'backpack', 'umbrella', 'handbag', 'tie', 'suitcase', 'frisbee', 'skis', 'snowboard', 'sports ball', 'kite', 'baseball bat', 'baseball glove', 'skateboard', 'surfboard', 'tennis racket', 'bottle', 'wine glass', 'cup', 'fork', 'knife', 'spoon', 'bowl', 'banana', 'apple', 'sandwich', 'orange', 'broccoli', 'carrot', 'hot dog', 'pizza', 'donut', 'cake', 'chair', 'couch', 'potted plant', 'bed', 'dining table', 'toilet', 'tv', 'laptop', 'mouse', 'remote', 'keyboard', 'cell phone', 'microwave', 'oven', 'toaster', 'sink', 'refrigerator', 'book', 'clock', 'vase', 'scissors', 'teddy bear', 'hair drier', 'toothbrush'];

        let session;

        async function loadModel() {
            session = await ort.InferenceSession.create('yolov8n.onnx');
        }

        async function loadImage(url) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.src = url;
                img.onload = () => resolve(img);
                img.onerror = reject;
            });
        }

        async function runInference() {
            const imageUrl = document.getElementById('image-url').value;
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');

            const img = await loadImage(imageUrl);
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const inputTensor = new Float32Array(1 * 3 * 640 * 640);

            // Preprocess image
            for (let i = 0; i < 640; i++) {
                for (let j = 0; j < 640; j++) {
                    const pixel = (i * 640 + j) * 4;
                    inputTensor[i * 640 + j] = imageData.data[pixel] / 255.0;
                    inputTensor[640 * 640 + i * 640 + j] = imageData.data[pixel + 1] / 255.0;
                    inputTensor[2 * 640 * 640 + i * 640 + j] = imageData.data[pixel + 2] / 255.0;
                }
            }

            const feeds = { images: new ort.Tensor('float32', inputTensor, [1, 3, 640, 640]) };
            const results = await session.run(feeds);
            const output = results.output.data;

            // Post-process output
            ctx.font = "16px Arial";
            for (let i = 0; i < output.length; i += 6) {
                const classIdx = output[i + 1];
                const confidence = output[i + 2];
                const x1 = output[i + 3] * canvas.width;
                const y1 = output[i + 4] * canvas.height;
                const x2 = output[i + 5] * canvas.width;
                const y2 = output[i + 6] * canvas.height;

                if (confidence > 0.5) {
                    ctx.strokeStyle = 'red';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(x1, y1, x2 - x1, y2 - y1);
                    ctx.fillStyle = 'red';
                    ctx.fillText(`${classNames[classIdx]}: ${(confidence * 100).toFixed(2)}%`, x1, y1 - 5);
                }
            }
        }

        // Load the model when the page loads
        window.onload = loadModel;
    </script>
</body>
</html>
